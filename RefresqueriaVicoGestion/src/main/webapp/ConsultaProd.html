<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Consulta de Productos</title>
  <link rel="stylesheet" href="CSS/ConsultaProductos.css" />
</head>
<body>

<div class="encabezado-esquina">
  <div class="arriba">REFRESQUERIA</div>
  <div class="abajo">VICO</div>
</div>

<a class="volver" href="MenuInv.html">&larr; Volver</a>
<h1>Consulta de Productos</h1>

<div class="botones">
  <button onclick="ordenarPor('id')">Ordenar por ID</button>
  <button onclick="ordenarPor('nombre')">Ordenar por Nombre</button>
  <button onclick="ordenarPor('precio')">Ordenar por Precio</button>
  <button onclick="eliminarSeleccionados()">Eliminar seleccionados</button>
</div>

<table id="tablaProductos">
  <thead>
  <tr>
    <th><input type="checkbox" id="seleccionarTodo" title="Seleccionar todo" /></th>
    <th>ID</th>
    <th>Nombre</th>
    <th>Precio</th>
    <th>Stock</th>
    <th>Vendidos</th> <!-- Nueva columna -->
    <th>Acciones</th>
  </tr>
  </thead>
  <tbody>
  <!-- filas generadas por JS -->
  </tbody>
</table>

<!-- FORMULARIO PARA ALTA Y MODIFICACIÓN -->
<div style="margin-top: 20px; background-color: #d0f0c0; padding: 10px;">
  <h3 style="margin: 0 0 10px 0;">Alta / Modificación de Producto</h3>
  <form id="formProducto">
    <input type="hidden" id="idProd" />
    <input type="text" id="nombreProd" placeholder="Nombre" required />
    <input type="number" step="0.01" id="precioProd" placeholder="Precio" required />
    <input type="number" id="stockProd" placeholder="Stock" min="0" required />
    <input type="number" id="vendidosProd" placeholder="Vendidos" min="0" required /> <!-- Campo nuevos -->
    <button type="submit">Guardar</button>
    <button type="button" onclick="limpiarFormularioProducto()">Cancelar</button>
  </form>
</div>

<script>
  const API_PRODUCTOS = 'http://localhost:8081/RefresqueriaVicoGestion/api/productos';
  let productos = [];
  let seleccionados = new Set();

  document.addEventListener("DOMContentLoaded", () => {
    cargarProductos();
    document.getElementById("formProducto").addEventListener("submit", guardarProducto);
    document.getElementById('seleccionarTodo').addEventListener('change', seleccionarTodos);
  });

  async function cargarProductos() {
    try {
      const resp = await fetch(API_PRODUCTOS);
      if (!resp.ok) throw new Error('Error al cargar productos');
      productos = await resp.json();
      seleccionados.clear();
      document.getElementById('seleccionarTodo').checked = false;
      document.getElementById('seleccionarTodo').indeterminate = false;
      mostrarProductos(productos);
    } catch (error) {
      alert('No se pudieron cargar los productos: ' + error.message);
    }
  }

  function mostrarProductos(lista) {
    const tbody = document.querySelector("#tablaProductos tbody");
    tbody.innerHTML = "";

    lista.forEach(prod => {
      tbody.innerHTML += `
        <tr>
          <td><input type="checkbox" class="chkProducto" data-id="${prod.id}" ${seleccionados.has(prod.id) ? 'checked' : ''} /></td>
          <td>${prod.id}</td>
          <td>${prod.nombre}</td>
          <td>$${parseFloat(prod.precio).toFixed(2)}</td>
          <td>${prod.stock != null ? prod.stock : 0}</td>
          <td>${prod.vendidos != null ? prod.vendidos : 0}</td> <!-- Mostrar vendidos -->
          <td>
            <button onclick='editarProducto(${JSON.stringify(prod)})'>Modificar</button>
            <button onclick='eliminarProducto(${prod.id})'>Eliminar</button>
          </td>
        </tr>
      `;
    });

    document.querySelectorAll(".chkProducto").forEach(chk => {
      chk.addEventListener("change", function() {
        const id = parseInt(this.dataset.id);
        this.checked ? seleccionados.add(id) : seleccionados.delete(id);
        actualizarSeleccionarTodo();
      });
    });
  }

  function seleccionarTodos() {
    const checkboxes = document.querySelectorAll('.chkProducto');
    seleccionados.clear();
    if (this.checked) {
      checkboxes.forEach(chk => {
        chk.checked = true;
        seleccionados.add(parseInt(chk.dataset.id));
      });
    } else {
      checkboxes.forEach(chk => chk.checked = false);
    }
    actualizarSeleccionarTodo();
  }

  function actualizarSeleccionarTodo() {
    const total = productos.length;
    const selCount = seleccionados.size;
    const chkTodo = document.getElementById('seleccionarTodo');
    chkTodo.checked = selCount === total && total > 0;
    chkTodo.indeterminate = selCount > 0 && selCount < total;
  }

  function ordenarPor(campo) {
    const copia = [...productos];
    copia.sort((a, b) => {
      if (campo === "id" || campo === "precio" || campo === "stock" || campo === "vendidos")
        return a[campo] - b[campo];
      return a[campo].localeCompare(b[campo]);
    });
    mostrarProductos(copia);
  }

  async function eliminarSeleccionados() {
    if (seleccionados.size === 0) {
      alert("Selecciona al menos un producto para eliminar.");
      return;
    }

    if (!confirm(`¿Eliminar ${seleccionados.size} producto(s)?`)) return;

    try {
      for (const id of seleccionados) {
        const resp = await fetch(`${API_PRODUCTOS}?id=${id}`, { method: 'DELETE' });
        if (!resp.ok) throw new Error(`Error eliminando producto ID ${id}`);
        const resultado = await resp.json();
        if (!resultado.exito) throw new Error(`No se pudo eliminar producto ID ${id}`);
      }
      alert('Productos eliminados.');
      cargarProductos();
    } catch (error) {
      alert("Error: " + error.message);
    }
  }

  async function eliminarProducto(id) {
    if (!confirm("¿Seguro que deseas eliminar este producto?")) return;

    try {
      const resp = await fetch(`${API_PRODUCTOS}?id=${id}`, { method: 'DELETE' });
      if (!resp.ok) throw new Error("Error al eliminar");
      const resultado = await resp.json();
      if (!resultado.exito) throw new Error("No se pudo eliminar");
      cargarProductos();
    } catch (e) {
      alert("Error: " + e.message);
    }
  }

  function editarProducto(prod) {
    document.getElementById("idProd").value = prod.id;
    document.getElementById("nombreProd").value = prod.nombre;
    document.getElementById("precioProd").value = prod.precio;
    document.getElementById("stockProd").value = prod.stock != null ? prod.stock : 0;
    document.getElementById("vendidosProd").value = prod.vendidos != null ? prod.vendidos : 0;
  }

  function limpiarFormularioProducto() {
    document.getElementById("formProducto").reset();
    document.getElementById("idProd").value = "";
  }

  async function guardarProducto(e) {
    e.preventDefault();

    const producto = {
      id: document.getElementById("idProd").value || null,
      nombre: document.getElementById("nombreProd").value,
      precio: parseFloat(document.getElementById("precioProd").value),
      stock: parseInt(document.getElementById("stockProd").value) || 0,
      vendidos: parseInt(document.getElementById("vendidosProd").value) || 0
    };

    const metodo = producto.id ? "PUT" : "POST";

    try {
      const resp = await fetch(API_PRODUCTOS, {
        method: metodo,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(producto)
      });

      if (resp.ok) {
        limpiarFormularioProducto();
        cargarProductos();
      } else {
        const error = await resp.text();
        alert("Error: " + error);
      }
    } catch (err) {
      alert("Error al guardar: " + err.message);
    }
  }
</script>

</body>
</html>
